<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Sharer'>/**
</span> * @class  Sharer
 * @author  Flavio De Stefano &lt;flavio.destefano@caffeinalab.com&gt;
 * Provide functions to simplify sharing across platforms and social networks
 *
 * Be more Social on your app! ;)
 *
 */

<span id='Sharer-property-config'>/**
</span> * @type {Object}
 */
var config = _.extend({
}, Alloy.CFG.T.sharer);
exports.config = config;


var Util = require(&#39;T/util&#39;);
var globalCallback = null;// Handle all callbacks

var dkNappSocial = null;
var Facebook = null;
var benCodingSMS = null;

function onSocialComplete(e) {
	if (!_.isFunction(globalCallback)) return;

	e.type = &#39;complete&#39;;
	if (e.activityName) e.platform = e.activityName;
	globalCallback(e);
}

function onSocialCancel(e) {
	if (!_.isFunction(globalCallback)) return;

	e.type = &#39;cancelled&#39;;
	if (e.activityName) e.platform = e.activityName;
	globalCallback(e);
}

function parseArgs(args) {
	if (!_.isObject(args)) return {};

	if (args.image != null) {
		if (_.isObject(args.image)) {
			if (args.image.resolve) {
				args.imageBlob = args.image;
				args.image = args.imageBlob.resolve();
			} else if (args.image.nativePath) {
				args.imageBlob = args.image;
				args.image = args.imageBlob.nativePath;
			} else {
				delete args.image;
			}
		} else if (_.isString(args.image) &amp;&amp; args.image.indexOf(&#39;://&#39;) !== -1) {
			args.imageUrl = args.image;
		}
	}

	if (args.link != null) {
		args.url = args.link;
		delete args.link;
	}

	if (args.removeIcons === &#39;ALL&#39;) args.removeIcons = &#39;print,sms,copy,contact,camera,readinglist&#39;;

	if (args.text != null &amp;&amp; args.url != null) {
		args.fullText = args.text + &#39; (&#39; + args.url + &#39;)&#39;;
	} else if (args.text != null) {
		args.fullText = args.text;
	} else if (args.url != null) {
		args.fullText = args.url;
	}

	if (_.isFunction(args.callback)) {
		globalCallback = args.callback;
		delete args.callback;
	}

	return args;
}

<span id='Sharer-method-facebook'>/**
</span> * @method facebook
 * Share on Facebook
 * @param {Object} args
 */
function facebook(args) {
	args = parseArgs(args);

	// IOS-BUG: iOS Sharer doesn&#39;t share Facebook links
	if (/https?\:\/\/(www\.)?facebook\.com/.test(args.url)) args.useSDK = true;

	if (args.useSDK !== true &amp;&amp; dkNappSocial !== null &amp;&amp; dkNappSocial.isFacebookSupported()) {

		/*
		Native iOS dialog
		*/

		dkNappSocial.facebook({
			text: args.text,
			image: args.image,
			url: args.url
		});

	} else if (Facebook != null) {

		/*
		Facebook SDK feed dialog
		*/

		Facebook.dialog(&#39;feed&#39;, {
			name: args.title,
			description: args.text,
			link: args.url,
			picture: args.imageUrl
		}, function(e) {
			if (e.cancelled === true) {
				onSocialCancel({
					success: false,
					platform: &#39;facebook&#39;
				});
				return;
			}

			onSocialComplete({
				success: e.success,
				platform: &#39;facebook&#39;
			});
		});

	} else {

		/*
		Browser sharing
		*/
		Ti.Platform.openURL(&#39;https://www.facebook.com/dialog/share&#39; + require(&#39;T/util&#39;).buildQuery({
			app_id: Ti.App.Properties.getString(&#39;ti.facebook.appid&#39;, false),
			display: &#39;touch&#39;,
			redirect_uri: Ti.App.url,
			href: args.url
		}));

	}
}
exports.facebook = facebook;

<span id='Sharer-method-twitter'>/**
</span> * @method twitter
 * Share on Twitter
 * @param {Object} args
 */
function twitter(args) {
	parseArgs(args);

	var WEB_URL = &#39;http://www.twitter.com/intent&#39;;
	var webIntent = null;

	if (args.retweet != null) {
		webIntent = WEB_URL + &#39;/retweet&#39; + require(&#39;T/util&#39;).buildQuery({
			tweet_id: args.retweet
		});
	} else {
		webIntent = WEB_URL + &#39;/tweet&#39; + require(&#39;T/util&#39;).buildQuery({
			text: args.text,
			url: args.url
		});
	}

	if (OS_ANDROID) {

		/*
		Android Intent automatic handle
		*/

		Ti.Platform.openURL(webIntent);

	} else {

		if (args.native !== false &amp;&amp; dkNappSocial !== null &amp;&amp; dkNappSocial.isTwitterSupported()) {

			/*
			Native iOS Dialog
			*/

			var text = args.text;
			if (args.retweetUser) {
				text = &#39;RT @&#39; + args.retweetUser + &#39;: &#39; + text;
			}

			dkNappSocial.twitter({
				text: text,
				image: args.image,
				url: args.url
			});

		} else  {

			/*
			Twitter app native sharing
			Browser fallback
			*/

			Util.openURL(&#39;twitter://post?message=&#39; + encodeURIComponent(args.fullText), webIntent);

		}
	}

}
exports.twitter = twitter;

<span id='Sharer-method-mail'>/**
</span> * @method mail
 * Share via Mail
 * @param {Object} args
 */
function mail(args) {
	args = parseArgs(args);

	var $dialog = Ti.UI.createEmailDialog({
		subject: args.subject || args.title,
		messageBody: args.fullText,
	});

	if (args.imageBlob != null) {
		$dialog.addAttachment(args.imageBlob);
	}

	$dialog.addEventListener(&#39;complete&#39;, function(e) {
		if (e.result === this.CANCELLED) {
			onSocialCancel({
				success: false,
				platform: &#39;mail&#39;
			});
			return;
		}

		onSocialComplete({
			success: (e.result === this.SENT),
			platform: &#39;mail&#39;
		});
	});

	$dialog.open();
}
exports.mail = mail;
exports.email = mail;


<span id='Sharer-method-googleplus'>/**
</span> * @method googleplus
 * Share on Google Plus
 * @param {Object} args
 */
function googleplus(args) {
	args = parseArgs(args);
	if (_.isEmpty(args.url)) {
		Ti.API.error(&#39;Sharer: sharing on G+ require a URL&#39;);
		return;
	}

	/*
	Browser unique implementation
	*/
	Ti.Platform.openURL(&#39;https://plus.google.com/share?url=&#39; + encodeURIComponent(args.url));
}
exports.googleplus = googleplus;


<span id='Sharer-method-whatsapp'>/**
</span> * @method whatsapp
 * Share via Whatsapp
 * @param {Object} args
 */
function whatsapp(args) {
	args = parseArgs(args);

	if (OS_IOS) {

		/*
		Native protocol binding
		 */
		Util.openURL(&#39;whatsapp://send?text=&#39; + args.fullText, function() {
			require(&#39;T/dialog&#39;).confirmYes(null, String.format(L(&#39;sharer_app_not_installed&#39;), &#39;Whatsapp&#39;), function() {
				Util.openInStore(&#39;310633997&#39;);
			});
		});

	} else if (OS_ANDROID) {

		/*
		Android Intent using package
		*/
		try {
			var intent = Ti.Android.createIntent({
				action: Ti.Android.ACTION_SEND,
				type: &#39;text/plain&#39;,
				packageName: &#39;com.whatsapp&#39;
			});
			if (intent == null) throw new Error();
			intent.putExtra(Ti.Android.EXTRA_TEXT, args.fullText);
			Ti.Android.currentActivity.startActivity(intent, L(&#39;Share&#39;));
		} catch (err) {
			require(&#39;T/dialog&#39;).confirmYes(null, String.format(L(&#39;sharer_app_not_installed&#39;), &#39;Whatsapp&#39;), function() {
				Util.openInStore(&#39;com.whatsapp&#39;);
			});
		}

	}
}
exports.whatsapp = whatsapp;


<span id='Sharer-method-sms'>/**
</span> * @method sms
 * Share via Messages
 * @param {Object} args
 */
function sms(args) {
	args = parseArgs(args);

	if (OS_IOS) {

		if (benCodingSMS == null) {
			Ti.API.error(&#39;Sharer: `bencoding.sms` module is required to send SMS&#39;);
			return;
		}

		/*
		iOS Native modal
		*/

		var $dialog = benCodingSMS.createSMSDialog({
			messageBody: args.fullText
		});

		$dialog.addEventListener(&#39;completed&#39;, function(){
			onSocialComplete({ success: true, platform: &#39;messages&#39; });
		});
		$dialog.addEventListener(&#39;cancelled&#39;, function(){
			onSocialCancel({ success: false, platform: &#39;messages&#39; });
		});
		$dialog.addEventListener(&#39;errored&#39;, function(){
			onSocialComplete({ success: false, platform: &#39;messages&#39; });
		});

		$dialog.open({ animated: true });

	} else if (OS_ANDROID) {

		/*
		Android Native
		*/

		var intent = Ti.Android.createIntent({
			action: Ti.Android.ACTION_VIEW,
			type: &#39;vnd.android-dir/mms-sms&#39;,
		});
		intent.putExtra(&#39;sms_body&#39;, args.fullText);
		Ti.Android.currentActivity.startActivity(intent, L(&#39;Share&#39;));

	}

}
exports.sms = sms;


<span id='Sharer-method-activity'>/**
</span> * Share using iOS ActivityPopover or Android Intents
 * @param {Object} args
 */
function activity(args) {
	args = parseArgs(args);

	if (OS_IOS) {

		/*
		iOS Activity native
		*/

		if (dkNappSocial == null) {
			Ti.API.error(&#39;Sharer: module `dk.napp.social` is required for `activity` method&#39;);
			return;
		}

		dkNappSocial[ Ti.Platform.osname===&#39;ipad&#39; ? &#39;activityPopover&#39; : &#39;activityView&#39; ]({
			text: args.text,
			title: args.title,
			image: args.image,
			removeIcons: args.removeIcons,
			view: args.view,
			url: args.url
		}, args.customIcons || []);

	} else if (OS_ANDROID) {

		/*
		Android intents
		*/

		/*
		FACEBOOK-BUG
		EXTRA_TEXT
		https://developers.facebook.com/bugs/332619626816423
		*/

		var intent = Ti.Android.createIntent({
			action: Ti.Android.ACTION_SEND
		});

		if (args.fullText) intent.putExtra(Ti.Android.EXTRA_TEXT, args.fullText);
		if (args.title) intent.putExtra(Ti.Android.EXTRA_TITLE, args.title);
		if (args.image) intent.putExtraUri(Ti.Android.EXTRA_STREAM, args.image);

		Ti.Android.currentActivity.startActivity(Ti.Android.createIntentChooser(intent, L(&#39;Share&#39;)));

	}
}
exports.activity = activity;
exports.multi = activity;

/*
Init
*/

// Load modules

try {
	Facebook = require(&#39;facebooka&#39;);
	if (Facebook == null) throw &#39;err&#39;;

	if (Facebook.appid == null) {
		if (Ti.App.Properties.hasProperty(&#39;ti.facebook.appid&#39;)) {
			Facebook.appid = Ti.App.Properties.getString(&#39;ti.facebook.appid&#39;, false);
		} else {
			Ti.API.warn(&#39;Sharer: Please specify a Facebook AppID&#39;);
		}
	}

} catch (ex) {
	Ti.API.warn(&#39;Sharer: `facebook` can\&#39;t be loaded&#39;);
}

if (OS_IOS) {

	try {
		dkNappSocial = require(&#39;dk.napp.social&#39;);
		if (dkNappSocial == null) throw &#39;err&#39;;
	} catch (ex) {
		Ti.API.warn(&#39;Sharer: `dk.napp.social` can\&#39;t be loaded&#39;);
	}

	try {
		benCodingSMS = require(&#39;bencoding.sms&#39;);
		if (benCodingSMS == null) throw &#39;err&#39;;

		dkNappSocial.addEventListener(&#39;complete&#39;, onSocialComplete);
		dkNappSocial.addEventListener(&#39;cancelled&#39;, onSocialCancel);

	} catch (ex) {
		Ti.API.warn(&#39;Sharer: `bencoding.sms` can\&#39;t be loaded&#39;);
	}

}</pre>
</body>
</html>
