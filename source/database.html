<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Cache-Database'>/**
</span> * @class  Cache.Database
 * @author  Flavio De Stefano &lt;flavio.destefano@caffeinalab.com&gt;
 * Fast cache module using SQLite
 */

<span id='Cache-Database-property-config'>/**
</span> * @type {Object}
 */
var config = _.extend({
}, Alloy.CFG.T.cache ? Alloy.CFG.T.cache.database : {});
exports.config = config;


var Util = require(&#39;T/util&#39;);
var DB = null;

<span id='Cache-Database-method-get'>/**
</span> * Get an entry
 * @param  {String} hash [description]
 * @return {Object}
 */
function get(hash) {
	var row = DB.execute(&#39;SELECT expire, value, info FROM cache WHERE hash = ? LIMIT 1&#39;, hash);
	if (row.isValidRow() === false) return;

	var expire = parseInt(row.fieldByName(&#39;expire&#39;), 10);
	if (expire !== -1 &amp;&amp; Util.now() &gt; expire) return;

	return {
		expire: expire,
		value: row.fieldByName(&#39;value&#39;),
		info: Util.parseJSON(row.fieldByName(&#39;info&#39;))
	};
}
exports.get = get;

<span id='Cache-Database-method-set'>/**
</span> * Set a new entry
 * @param {String} 	hash
 * @param {Mixed} 	value
 * @param {Number} 	ttl
 * @param {Object} 	info
 */
function set(hash, value, ttl, info) {
	var expire = ttl != null ? Util.fromnow(ttl) : -1;
	var q = &#39;INSERT OR REPLACE INTO cache (hash, expire, value, info) VALUES (?, ?, ?, ?)&#39;;
	DB.execute(q, hash, expire, value, JSON.stringify(info));
}
exports.set = set;

<span id='Cache-Database-method-prune'>/**
</span> * Prune all
 */
function prune() {
	return DB.execute(&#39;DELETE FROM cache WHERE 1&#39;);
}
exports.prune = prune;

<span id='Cache-Database-method-remove'>/**
</span> * Remove an entry
 * @param  {String} 	hash
 */
function remove(hash) {
	DB.execute(&#39;DELETE FROM cache WHERE hash = ?&#39;, hash);
}
exports.remove = remove;


/*
Init
*/

DB = require(&#39;T/db&#39;).open();
DB.execute(&#39;CREATE TABLE IF NOT EXISTS cache (hash TEXT PRIMARY KEY, expire INTEGER, value TEXT, info TEXT)&#39;);
</pre>
</body>
</html>
